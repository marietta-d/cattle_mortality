---
title: "eda_combined"
author: "Marietta_Dalamanga"
date: "2024-07-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory data analysis

```{r}
library(tidyverse)
library(dplyr)
library(visdat)
library(splitstackshape)
library(tidyr)
library(survminer)
library(data.table)
library(ggplot2)
library(lubridate)
library(scales)
library(ggpubr)
```

Load dataset 
```{r}
combined_data <- read.csv("./data/merged_weather_wide.csv")
head(combined_data)
```


```{r}
colnames(combined_data)
str(combined_data)
```



```{r}
combined_data[,c("Herd_Id", "Abbatoir", "Dvo_Code", "Breed", "Sex", "Abattoir_._Died_on_Farm", "Beef_or_Dairy")] = 
  lapply(combined_data[,c("Herd_Id", "Abbatoir", "Dvo_Code", "Breed", "Sex", "Abattoir_._Died_on_Farm", "Beef_or_Dairy")],
                                function(x) as.factor(x))
```

```{r}
total_animals <- as.numeric(nrow(combined_data))
```

```{r}
mean_age_days <- mean(combined_data$days_alive)
mean_age_years <- mean(combined_data$years_alive)
mean_age_months <- mean(combined_data$months_alive)
```



```{r}
ftable(combined_data$Sex, combined_data$Beef_or_Dairy)
```


### Age variables check for outliers

```{r}
age <- c("years_alive", "days_alive", "months_alive")
summary(combined_data[, age])

```


Days alive
```{r}
days_alive_histogram <-ggplot(combined_data, aes(x=days_alive)) +
  geom_histogram(binwidth=60, fill="steelblue") +
  geom_vline(aes(xintercept= mean(days_alive), color="red")) +
  labs(title="Histogram of age in days", x="days", y="Animals")+
  theme_minimal()
ggsave("./data/combined_figs/days_alive_histogram.png", plot=days_alive_histogram, width = 8, height = 6 )
days_alive_histogram
```

age in months
```{r}
months_alive_histogram <- ggplot(combined_data, aes(x=months_alive)) +
  geom_histogram(binwidth=1, fill="steelblue") +
  labs(title="Histogram of age in months", x="Months", y="Animals")+
  theme_minimal()
ggsave("./data/combined_figs/months_alive_histogram.png", plot=months_alive_histogram, width = 8, height = 6 )
months_alive_histogram
```


age in years
```{r}
years_alive_histogram <- ggplot(combined_data, aes(x=years_alive)) +
  geom_histogram(binwidth=1, fill="steelblue") +
  labs(title="Histogram of age in years", x="Years", y="Animals")+
  theme_minimal()
ggsave("./data/combined_figs/years_alive_histogram.png", plot=years_alive_histogram, width = 8, height = 6 )
years_alive_histogram
```

male animals summary
```{r}
m <- combined_data %>%
  subset(Sex=="M") 

summary(m[, age])

```

female animals summary
```{r}

f <- combined_data %>%
  subset(Sex=="F") 

summary(f[, age])

```

bulls summary
```{r}
b <- combined_data %>%
  subset(Sex=="B") 

summary(b[, age])

```

Histogram of age in years by Sex
```{r}
years_vs_sex <- ggplot(combined_data, aes(x = years_alive, fill = Sex)) +
  geom_histogram(alpha = 0.6, position = "identity", bins =10) +
  facet_wrap(~Sex)+
  labs(title = "Histograms of Age by Sex",
       x = "Age in years",
       y = "No of animals") +
  theme_minimal()
ggsave("./data/combined_figs/years_vs_sex.png", plot=years_vs_sex, width = 8, height = 6 )
years_vs_sex
```

Dairy animals summary
```{r}
d <- combined_data %>%
  subset(Beef_or_Dairy=="Dairy") 

summary(d[, age])

```

Beef animals summary
```{r}
be <- combined_data %>%
  subset(Beef_or_Dairy=="Beef") 

summary(be[, age])

```

Histogram of age in years by production type
```{r}
ggplot(combined_data, aes(x = years_alive, fill = Beef_or_Dairy)) +
  geom_histogram(alpha = 0.6, position = "identity", bins =10) +
  facet_wrap(~Beef_or_Dairy)+
  labs(title = "Histograms of Age by Production type",
       x = "Age in years",
       y = "No of animals") +
  theme_minimal()
```


Box plot of years alive
```{r}
age_years_box_plot <- ggplot(combined_data, aes(y=years_alive)) +
  geom_boxplot() +
  labs(title="boxplot")+
  theme_minimal()
ggsave("./data/combined_figs/age_years_box_plot.png", plot=age_years_box_plot, width = 8, height = 6 )
age_years_box_plot

```

box plot based on sex
```{r}
age_years_vs_sex_box_plot <- ggplot(combined_data, aes(x = Sex, y = years_alive, fill = Sex)) +
  geom_boxplot() +
  labs(title = "Box Plot of Age Based on Sex",
       x = "Sex",
       y = "Age in years") +
  theme_minimal()
ggsave("./data/combined_figs/age_years_vs_sex_box_plot.png", plot=age_years_vs_sex_box_plot, width = 8, height = 6 )
age_years_vs_sex_box_plot
```


box plot based on production type
```{r}
age_years_vs_prod_box_plot <- ggplot(combined_data, aes(x = Beef_or_Dairy, y = years_alive, fill = Beef_or_Dairy)) +
  geom_boxplot() +
  labs(title = "Life span per production type (with outliers)",
       x = "Production type",
       y = "Age [yr]") + theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA))  
ggsave("./data/combined_figs/age_years_vs_prod_box_plot.png", plot=age_years_vs_prod_box_plot, width = 8, height = 6, bg = "transparent" )
age_years_vs_prod_box_plot
```


#### Check for outliers

```{r}
outliers1 <- (combined_data$years_alive < quantile(combined_data$years_alive, 0.25) - 1.5*IQR(combined_data$years_alive)) | (combined_data$years_alive > quantile(combined_data$years_alive, 0.75) + 1.5*IQR(combined_data$years_alive)) 
sum(outliers1)
```



If we take the 1.5*IQR the data considered outliers are 223471.
Animals over 7 years old consider outliers, 19% of the female animals and 18% of the Dairy animals 
```{r}
No_Beef <- sum(combined_data$Beef_or_Dairy == "Beef")
No_Dairy <- sum(combined_data$Beef_or_Dairy == "Dairy")
No_Male <- sum(combined_data$Sex == "M")
No_Female <- sum(combined_data$Sex == "F")
No_Bull <- sum(combined_data$Sex == "B")


outliers1_info <- summary(combined_data[outliers1, c("Sex", "Beef_or_Dairy", "Total_Conditions_per_Animal", "years_alive")])
outliers1_info
```


```{r}
paste("proportion of beef animals consider outliers = ", 110836/No_Beef)
paste("proportion of Dairy animals consider outliers = ", 112635/No_Dairy)

paste("proportion of Male animals consider outliers = ", 163/No_Male)
paste("proportion of Female animals consider outliers = ", 219746/No_Female)
paste("proportion of Bulls consider outliers = ", 3562/No_Bull)
proportion_of_outliers1 <-sum(outliers1)/nrow(combined_data) *100
paste("proportions of outliers=", proportion_of_outliers1)
```

If we take the 3*IQR 83165 animals are outliers. Above 10 years old are considered outliers, 4% for Dairy and 7% for Female. Overall outliers is approximately 4% of the dataset
```{r}
outliers3 <- (combined_data$years_alive < quantile(combined_data$years_alive, 0.25) - 3*IQR(combined_data$years_alive)) | (combined_data$years_alive > quantile(combined_data$years_alive, 0.75) + 3*IQR(combined_data$years_alive)) 
proportion_of_outliers <-sum(outliers3)/nrow(combined_data) *100
outliers3_info <- summary(combined_data[outliers3, c("Sex", "Beef_or_Dairy", "Total_Conditions_per_Animal", "years_alive")])
print(outliers3_info)
print(proportion_of_outliers)
print(sum(outliers3))
```

```{r}
paste("proportion of beef animals consider outliers = ", 57071/No_Beef*100)
paste("proportion of Dairy animals consider outliers = ", 26094/No_Dairy*100)

paste("proportion of Male animals consider outliers = ", 30/No_Male *100)
paste("proportion of Female animals consider outliers = ", 82068/No_Female*100)
paste("proportion of Bulls consider outliers = ", 1067/No_Bull*100)
```


Delete outliers
```{r}
# We will take the 3*IQR
combined_data_without_outliers <- combined_data[!outliers3, ]
combined_data_without_outliers
```


```{r}
sapply(combined_data, nlevels)
combined_data_without_outliers <- droplevels(combined_data_without_outliers)
nlevels(combined_data_without_outliers)
sapply(combined_data_without_outliers, nlevels)
str(combined_data_without_outliers)
colnames(combined_data_without_outliers)
```


```{r}
age <- c("years_alive", "days_alive", "months_alive")
summary(combined_data_without_outliers[, age])
```



```{r}
total_animals_no_outliers <- as.numeric(nrow(combined_data_without_outliers))
summary(combined_data$years_alive[combined_data$Beef_or_Dairy=="Dairy"])
summary(combined_data$years_alive[combined_data$Beef_or_Dairy=="Beef"])
summary(combined_data_without_outliers$years_alive[combined_data_without_outliers$Beef_or_Dairy=="Dairy"])
summary(combined_data_without_outliers$years_alive[combined_data_without_outliers$Beef_or_Dairy=="Beef"])
```


```{r}
summary(combined_data_without_outliers$days_alive[combined_data_without_outliers$Beef_or_Dairy=="Dairy"])
summary(combined_data_without_outliers$days_alive[combined_data_without_outliers$Beef_or_Dairy=="Beef"])
```


male animals no outliers summary
```{r}
m <- combined_data_without_outliers %>%
  subset(Sex=="M") 

summary(m[, age])

```

Female animals no outliers summary
```{r}
f <- combined_data_without_outliers %>%
  subset(Sex=="F") 

summary(f[, age])

```

Bulls no outliers summary
```{r}
b <- combined_data_without_outliers %>%
  subset(Sex=="B") 

summary(b[, age])

```


dairy no outliers summary
```{r}
d <- combined_data_without_outliers %>%
  subset(Beef_or_Dairy=="Dairy") 

summary(d[, age])

```

Beef no outliers summary
```{r}
be<- combined_data_without_outliers %>%
  subset(Beef_or_Dairy=="Beef") 

summary(be[, age])

```


```{r}

# Days alive without outliers
days_alive_histogram_no_outliers <- ggplot(combined_data_without_outliers, aes(x=days_alive, after_stat(density))) +
  geom_histogram(binwidth=60, fill="steelblue") +
  geom_density(alpha=0.2, fill="#FF6666")+
  geom_vline(aes(xintercept= mean(days_alive), color="red")) +
  labs(title="Histogram of age in days", x="days", y="Animals")+
  theme_minimal()

ggsave("./data/combined_figs/days_alive_histogram_no_outliers.png", plot=days_alive_histogram_no_outliers, width = 8, height = 6 )
days_alive_histogram_no_outliers

```


age in years without outliers
```{r}
year_alive_histogram_no_outliers <- ggplot(combined_data_without_outliers, aes(x=years_alive)) +
  geom_histogram(binwidth=1, fill="steelblue") +
  geom_vline(aes(xintercept= mean(years_alive), color="red")) +
  labs(title="Histogram of age in years", x="Years", y="Animals")+
  theme_minimal()

ggsave("./data/combined_figs/year_alive_histogram_no_outliers.png", plot=year_alive_histogram_no_outliers, width = 8, height = 6)
year_alive_histogram_no_outliers

```

Histogram of age in years by Sex
```{r}
Years_alive_by_sex <- ggplot(combined_data_without_outliers, aes(x = years_alive, fill = Sex)) +
  geom_histogram(alpha = 0.6, position = "identity", bins =10) +
  facet_wrap(~Sex)+
  labs(title = "Histograms of Age by Sex",
       x = "Age in years",
       y = "No of animals") +
  theme_minimal()

ggsave("./data/combined_figs/Years_alive_by_sex.png", plot=Years_alive_by_sex, width = 8, height = 6)
Years_alive_by_sex

```

Histogram of age in years by production type
```{r}
years_alive_by_production <- ggplot(combined_data_without_outliers, aes(x = years_alive, fill = Beef_or_Dairy)) +
  geom_histogram(alpha = 0.6, position = "identity", bins =10) +
  facet_wrap(~Beef_or_Dairy)+
  labs(title = "Histograms of Age by Production type",
       x = "Age in years",
       y = "No of animals") +
  theme_minimal()

ggsave("./data/combined_figs/years_alive_by_production.png", plot=years_alive_by_production, width = 8, height = 6)
years_alive_by_production

```


Box plot of years alive
```{r}
box_plot_without_outliers <- ggplot(combined_data_without_outliers, aes(y=years_alive)) +
  geom_boxplot() +
  labs(title="boxplot")+
  theme_minimal()

ggsave("./data/combined_figs/box_plot_without_outliers.png", plot=box_plot_without_outliers, width = 8, height = 6)
box_plot_without_outliers

```

box plot based on sex
```{r}
box_plot_age_by_Sex <- ggplot(combined_data_without_outliers, aes(x = Sex, y = years_alive, fill = Sex)) +
  geom_boxplot() +
  labs(title = "Box Plot of Age Based on Sex",
       x = "Sex",
       y = "Age in years") +
  theme_minimal()

ggsave("./data/combined_figs/box_plot_age_by_Sex.png", plot=box_plot_age_by_Sex, width = 8, height = 6)
box_plot_age_by_Sex
```


box plot based on production type
```{r}
box_plot_age_by_production <- ggplot(combined_data_without_outliers, aes(x = Beef_or_Dairy, y = years_alive, fill = Beef_or_Dairy)) +
  geom_boxplot() +
  labs(title = "Life span per production type (no outliers)",
       x = "Production type",
       y = "Age [yr]") + theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA))  

ggsave("./data/combined_figs/box_plot_age_by_production.png", plot=box_plot_age_by_production, width = 8, height = 6, bg = "transparent")
box_plot_age_by_production

```


```{r}
age_summary <- aggregate(days_alive ~ Sex + Beef_or_Dairy , data=combined_data_without_outliers, mean)
age_summary
```


### Categorical variables


```{r}
Sex_summary <- combined_data_without_outliers %>%
  group_by(Sex) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
    percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
Sex_summary
```


Sex:

```{r}
Sex_freq_table <- combined_data_without_outliers %>%
  group_by(Sex) %>%
  tally(name="frequency") %>%
  arrange(desc(frequency))
Sex_freq_table

```


```{r}

animals_by_sex <- ggplot(combined_data, aes(x=Sex)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Animals by sex", x="Sex", y="Animals")+
  scale_y_continuous(breaks=c(Sex_freq_table$frequency)) +
  theme_minimal()
ggsave("./data/combined_figs/animals_by_sex.png", plot=animals_by_sex, width = 8, height = 6 )
animals_by_sex

animals_by_sex_no_outliers <- ggplot(combined_data_without_outliers, aes(x=Sex)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Animals by sex (no outliers)", x="Sex", y="Animals")+
  scale_y_continuous(breaks=c(Sex_freq_table$frequency)) +
  theme_minimal()
ggsave("./data/combined_figs/animals_by_sex_no_outliers.png", plot=animals_by_sex, width = 8, height = 6 )
animals_by_sex_no_outliers

animals_by_sex_both_plots <- ggarrange(animals_by_sex, animals_by_sex_no_outliers, ncol = 2)
ggsave("./data/combined_figs/animals_by_sex_both_plots.png", plot=animals_by_sex_both_plots, width = 8, height = 6, bg = "white", scale  = 2)

```


plot the sex of the animals by production category
The number of bulls and female animals that are for Dairy production is around half of the number of annimals for beef production and a bit less than one third of the male animals that are for beef production is for dairy production 
```{r}

sex_by_production <- ggplot(combined_data_without_outliers, aes(x=Sex)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Sex of animal by type of production", x="Sex", y="Count")+
  theme_minimal() +
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k")) +
  facet_wrap(~Beef_or_Dairy)

ggsave("./data/combined_figs/sex_by_production.png", plot=sex_by_production, width = 8, height = 6, bg="white", scale=2 )
sex_by_production
```


mean age of male dairy animals
```{r}
combined_data_without_outliers %>%
  filter(Beef_or_Dairy == "Dairy") %>%
  group_by(Sex)%>%
  summarize(mean_conditions = mean(Total_Conditions_per_Animal), 
            mean_age = mean(days_alive))


combined_data_without_outliers %>%
  filter(Beef_or_Dairy == "Beef") %>%
  group_by(Sex)%>%
  summarize(mean_conditions = mean(Total_Conditions_per_Animal), 
            mean_age = mean(days_alive))

```

the mean number of conditions existing in an animal is analogous with their age (both for dairy and beef animals). The younger an animal is died the less health conditions is has.
Thus females which live 3 times longer than males for dairy and 1.5 times longer than males for beef have in average more conditions than male

Healthy male animals
```{r}
healthy_animals <- combined_data_without_outliers %>%
  filter(Total_Conditions_per_Animal == 0)
unhealthy_animals <- combined_data_without_outliers %>%
  filter(Total_Conditions_per_Animal > 0)
mean_age_healthy_animals <- aggregate(days_alive ~ Sex + Beef_or_Dairy, data = healthy_animals, mean)
mean_age_healthy_animals
mean_age_unhealthy_animals <- aggregate(days_alive ~ Sex + Beef_or_Dairy, data = unhealthy_animals, mean)
mean_age_unhealthy_animals
```

```{r}

mean_age_all_data <- aggregate(days_alive ~ Sex + Beef_or_Dairy, data = combined_data_without_outliers, mean)
mean_age_all_data
```

```{r}
healthy_vs_unhealthy <- mean_age_all_data %>%
  mutate(healthy = mean_age_healthy_animals$days_alive, unhealthy = mean_age_unhealthy_animals$days_alive , difference = healthy-unhealthy)
healthy_vs_unhealthy
```

Healthy animals live less than the unhealthy ones the biggest differences is for beef bulls(465.61 days) and dairy female(353.37 days).
Why Bulls and Female beef animals live so much longer than the male beef animals?
Bulls and male dairy animals are not slaughter for meet?
why do they live approximatelly 4.5 months more than male beef animals?



Herd_id:


```{r}
Herd_freq_table <- combined_data_without_outliers %>%
  group_by(Herd_Id) %>%
  summarise(frequency = n(), age_days= mean(days_alive), age_years=mean(years_alive)) %>%
  arrange(desc(frequency))
Herd_freq_table
Herd_freq_table <- Herd_freq_table %>%
  mutate(percentage = frequency/total_animals_no_outliers*100)
print(Herd_freq_table)
paste("mean age for small herds (<100) = ", mean(Herd_freq_table$age_days[Herd_freq_table$frequency < 100]), "days", "total number of small herds = ", nrow(Herd_freq_table[Herd_freq_table$frequency < 100, ]))
paste("mean age for medium size herds (>=100, <= 1000) = ", mean(Herd_freq_table$age_days[Herd_freq_table$frequency >=100 & Herd_freq_table$frequency <= 1000]), "days", "total number of medium size herds = ", nrow(Herd_freq_table[Herd_freq_table$frequency >=100 & Herd_freq_table$frequency <= 1000, ]))
paste("mean age for big herds (>1000) = ", mean(Herd_freq_table$age_days[Herd_freq_table$frequency >1000]), "days", "total number of small herds = ", nrow(Herd_freq_table[Herd_freq_table$frequency >1000, ]))

```


```{r}
combined_data_without_outliers %>%
  filter(Herd_Id=="2235596e92fa62703d8becf995e884058dafedb6") %>%
  aggregate(days_alive ~ Sex, mean)

```


Herd summary
```{r}
overall_percent_of_healty <- nrow(healthy_animals)/ total_animals_no_outliers *100
herd_summary <- combined_data_without_outliers %>%
  group_by(Herd_Id) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
herd_summary
```


```{r}

herd_summary %>%
  filter(number_of_animals == 1)
  

```





```{r}
most_populus_herds_bar_plot <- ggplot(Herd_freq_table[1:10, ], aes(x=factor(Herd_Id), y=frequency)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title="10 most populous herds", x="Herd id", y="No of Animals")+
  theme_minimal() +
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k")) +
  coord_flip()
most_populus_herds_bar_plot
ggsave("./data/combined_figs/most_populus_herds_bar_plot.png", plot=most_populus_herds_bar_plot, width=8, height=6, bg="white", scale=2)
```



```{r}
N <- 10
top_herds_ids <- combined_data_without_outliers %>%
  count(Herd_Id, sort=TRUE) %>%
  top_n(N, n) %>%
  pull(Herd_Id)


filtered_Herd_ids <- combined_data_without_outliers %>%
  filter(Herd_Id %in% top_herds_ids)


big_herd_by_production <- ggplot(filtered_Herd_ids, aes(x=Herd_Id,  fill=Beef_or_Dairy)) +
  geom_bar(position="fill", stat="count") +
  labs(title="Herd by type of production", x="Herd id", y="No of Animals")+
  theme_minimal() +
  coord_flip()
big_herd_by_production
ggsave("./data/combined_figs/big_herd_by_production.png", plot=big_herd_by_production, width=8, height=6, bg="white", scale=2)
```


Abattoir:
```{r} 

abattoir_freq_table <- combined_data_without_outliers %>%
  group_by(Abbatoir) %>%
  summarise(frequency = n()) %>%
  arrange(desc(frequency))
abattoir_freq_table

```

```{r}
abattoir_summary <- combined_data_without_outliers %>%
  group_by(Abbatoir) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
abattoir_summary

  combined_data_without_outliers %>% 
    filter(Abbatoir=="8a60fb1b9b40ed0fdc5d3c061e9388972f3bdce4") %>%
    filter(Total_Conditions_per_Animal>0)
```


```{r}
combined_data_without_outliers[combined_data_without_outliers$Abbatoir == "9abde47a328f28fc47333a1711c260a14715c2bb", ]
combined_data_without_outliers[combined_data_without_outliers$Abbatoir =="52d480596328cca7948b6f1f31e1f2b18590cf10", ]
combined_data_without_outliers[combined_data_without_outliers$Abbatoir == "432d3a852c6074754d640e8d1369a1c56b0d5805", ]
```

How many abattoirs were active every year we will use the dataset including the outliers
```{r}
# 2018
data_2018 <- combined_data_without_outliers %>% 
  filter(combined_data_without_outliers$Year == "2018")
abattoirs2018 <- unique(data_2018$Abbatoir)
num_abbatoirs_2018 <- n_distinct(data_2018$Abbatoir)
paste("number of Abattoir in 2018", num_abbatoirs_2018)
# 2019
data_2019 <- combined_data_without_outliers %>% 
  filter(combined_data_without_outliers$Year == "2019")
abattoirs2019 <- unique(data_2019$Abbatoir)
num_abbatoirs_2019 <- n_distinct(data_2019$Abbatoir)
paste("number of Abattoir in 2019", num_abbatoirs_2019)
# 2020
data_2020 <- combined_data_without_outliers %>% 
  filter(combined_data_without_outliers$Year == "2020")
abattoirs2020 <- unique(data_2020$Abbatoir)
num_abbatoirs_2020 <- n_distinct(data_2020$Abbatoir)
paste("number of Abattoir in 2019", num_abbatoirs_2020)
# 2021
data_2021 <- combined_data_without_outliers %>% 
  filter(combined_data_without_outliers$Year == "2021")
abattoirs2021 <- unique(data_2021$Abbatoir)
num_abbatoirs_2021 <- n_distinct(data_2021$Abbatoir)
paste("number of Abattoir in 2021", num_abbatoirs_2021)


```


```{r}

print(abattoirs2018)
print(abattoirs2019)
print(abattoirs2020)
print(abattoirs2021)

```

2018: 
"9abde47a328f28fc47333a1711c260a14715c2bb" # didn't exist after 2018
"52d480596328cca7948b6f1f31e1f2b18590cf10" # didn't exist after 2018
2019:
"432d3a852c6074754d640e8d1369a1c56b0d5805" # this abatttoir was closed during 2020
"ba747dbffafe62fb8bea541fd72df6d8c7afcb2f" # this one open in 2019


Bar plot of Abattoirs
```{r}
abattoir_by_production <- ggplot(combined_data_without_outliers, aes(x=Abbatoir)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="barplot of Abbatoir", x="Abattoir", y="No of Animals")+
  theme_minimal() +
  facet_wrap(~Beef_or_Dairy)+
  coord_flip() +
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k"))

abattoir_by_production
ggsave("./data/combined_figs/abattoir_by_production.png", plot=abattoir_by_production, width=8, height=6, bg="white", scale=2)
```

Dead Animals per year


```{r}
paste("in 2018 we had ", nrow(data_2018), "dead animals")
paste("in 2019 we had ", nrow(data_2019), "dead animals")
paste("in 2020 we had ", nrow(data_2020), "dead animals")
paste("in 2021 we had ", nrow(data_2021), "dead animals")


# create a table 
animals_by_year <- data.frame(year = c("2018", "2019", "2020", "2021"),
                              count = c(nrow(data_2018), nrow(data_2019), nrow(data_2020), nrow(data_2021)),
                              mean_age_days = c(mean(data_2018$days_alive), mean(data_2019$days_alive), mean(data_2020$days_alive), mean(data_2021$days_alive)),
                              mean_age_years = c(mean(data_2018$years_alive), mean(data_2019$years_alive), mean(data_2020$years_alive), mean(data_2021$years_alive))
                              )
```


```{r}
animals_by_year
```


Barplot of years

```{r}
# Plot count by year
barplot_animal_per_year <- ggplot(animals_by_year, aes(x = factor(year), y = count)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Dead cattle per year", x = "Year", y = "Cattle") +
  scale_y_continuous(labels= label_number(scale = 1e-3, suffix = "k")) +
  theme_minimal()

# Plot mean age in days by year
mean_age_days_per_year <- ggplot(animals_by_year, aes(x = factor(year), y = mean_age_days)) +
  geom_line(group = 1, color = "MediumTurquoise") +
  geom_point(color = "red") +
  scale_y_continuous(breaks = c(round(animals_by_year$mean_age_days, 2))) +
  labs(title = "Mean Age in Days by Year", x = "Year", y = "Mean Age (Days)") +
  theme_minimal()

# Plot mean age in years by year
mean_age_years_per_year <- ggplot(animals_by_year, aes(x = factor(year), y = mean_age_years)) +
  geom_line(group= 1, color="MediumTurquoise") +
  geom_point(color="red") +
  scale_y_continuous(breaks = c(round(animals_by_year$mean_age_years, 4))) +
  labs(title = "Mean Age in Years by Year", x = "Year", y = "Mean Age (Years)") +
  theme_minimal()


```

```{r}
ggsave("./data/combined_figs/barplot_animal_per_year.png", plot = barplot_animal_per_year, width = 8, height = 6)
ggsave("./data/combined_figs/mean_age_days_per_year.png", plot = mean_age_days_per_year, width = 8, height = 6)
ggsave("./data/combined_figs/mean_age_years_per_year.png", plot = mean_age_years_per_year, width = 8, height = 6)
```

```{r}
barplot_animal_per_year
mean_age_days_per_year
mean_age_years_per_year
```


```{r}
dvo_summary <- combined_data_without_outliers %>%
  group_by(Dvo_Code) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
dvo_summary
```


Dvo Code:

```{r}
Dvo_freq_table <- combined_data_without_outliers %>%
  group_by(Dvo_Code) %>%
  summarise(frequency = n()) %>%
  arrange(desc(frequency))
Dvo_freq_table
```


Distribution of Dvo
Newry has the biggest amount of animals second is Dungannon and third is Armagh. only Enniskillen has less than 100k animals
```{r}
bar_plot_Dvo <- ggplot(combined_data_without_outliers, aes(x=Dvo_Code)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Distribution of animals per DVO", x="DVO Code", y="No of Animals")+
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
bar_plot_Dvo
ggsave("./data/combined_figs/bar_plot_Dvo.png", plot = bar_plot_Dvo, width = 8, height = 6)
```

the proportion of Dairy animals per DVO code is between 25% and 40% coleraine has the biggest proportion of dairy animals 

```{r}
bar_plot_Dvo_by_production <- ggplot(combined_data_without_outliers, aes(x=Dvo_Code, fill = Beef_or_Dairy)) +
  geom_bar(position="fill", stat="count", color="steelblue") +
  labs(title="Distribution of animals per DVO", x="DVO Code", y="No of Animals")+
  #scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
bar_plot_Dvo_by_production
ggsave("./data/combined_figs/bar_plot_Dvo_by_production.png", plot = bar_plot_Dvo_by_production, width = 8, height = 6)
```


```{r}
# Calculate the exact counts for each Dvo_Code
counts <- table(combined_data_without_outliers$Dvo_Code)
counts
# Sort the counts and select up to 15 unique values
unique_counts <- sort(unique(as.numeric(counts)), decreasing = TRUE)
unique_counts
# Create the plot
ggplot(combined_data_without_outliers, aes(x=Dvo_Code)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Barplot of Dvo code", x="Dvo code", y="No of animals") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = unique_counts) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```


production by Dvo_Code
```{r}
ftable(combined_data_without_outliers$Dvo_Code, combined_data_without_outliers$Beef_or_Dairy)

```

```{r}
nlevels(combined_data_without_outliers$Breed)
combined_data_without_outliers %>%
  count(Breed)
# drop unused level
combined_data_without_outliers$Breed <- droplevels(combined_data_without_outliers$Breed)
nlevels(combined_data_without_outliers$Breed)
```

Breed:
82% of animals belongs to the 6.5% of breeds


```{r}
breed_summary <- combined_data_without_outliers %>%
  group_by(Breed) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))

most_populus_breeds <- breed_summary[1:7, ]
most_populus_breeds
# if I take the 7 most populous breeds I get 87% of the total animals and 89% of dairy and 86% of beef
sum(most_populus_breeds$number_of_animals) / total_animals_no_outliers
```




```{r}
Breed_freq_table <- combined_data_without_outliers %>%
  group_by(Breed) %>%
  summarise(No_of_animals = n()) %>%
  arrange(desc(No_of_animals))


proportion_of_breeds <- Breed_freq_table$No_of_animals/total_animals_no_outliers * 100

Breed_freq_table <- cbind(Breed_freq_table, proportion_of_breeds)
Breed_freq_table
sum(Breed_freq_table$No_of_animals <10)

# How many breeds have more than 100000 animals
paste("the proporrtion of breeds with more than 100.000 animals is", sum(Breed_freq_table$No_of_animals > 100000)/nrow(Breed_freq_table)*100, "%")
Big_breeds <- Breed_freq_table[Breed_freq_table$No_of_animals>100000, ]
paste("proportion of total animals in breeds with more than 100.000:",  sum(Big_breeds$proportion_of_breeds), "%")

# How many breeds have between 20 and 100.000 animals
paste("the proporrtion of breeds with animals between 20 and 100.000 is", (sum(Breed_freq_table$No_of_animals >=20 & Breed_freq_table$No_of_animals <= 100000))/nrow(Breed_freq_table)*100, "%")
average_breeds <- Breed_freq_table[Breed_freq_table$No_of_animals>=20 & Breed_freq_table$No_of_animals<= 100000, ]
paste("proportion of animals in breeds with more than 20 and less than 100.000 animals is:",  sum(average_breeds$proportion_of_breeds), "%")

# How many breeds have less than 20 animals
paste("the proporrtion of breeds with less than 20 animals is", sum(Breed_freq_table$No_of_animals <20)/nrow(Breed_freq_table)*100, "%")
small_breeds <- Breed_freq_table[Breed_freq_table$No_of_animals<20, ]
paste("proportion of total animals in breeds with less than 20 animals:",  sum(small_breeds$proportion_of_breeds), "%")
small_breeds
```

```{r}
N <- 20
top_breeds <- combined_data_without_outliers %>%
  count(Breed, sort=TRUE) %>%
  top_n(N, n) %>%
  pull(Breed)


filtered_breeds <- combined_data_without_outliers %>%
  filter(Breed %in% top_breeds)


bar_plot_top_breeds <- ggplot(filtered_breeds, aes(x=reorder(Breed,Breed,
                     function(x) length(x)))) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Top breeds", x="Breed", y="Count")+ theme(axis.text.x = element_text(color = "grey20", size = 14, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 14, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 14, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 14, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) +
  coord_flip() +
  scale_y_continuous(labels = label_number(scale = 1e-3, suffix = "k")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

bar_plot_top_breeds
ggsave("./data/combined_figs/bar_plot_top_breeds.png", plot = bar_plot_top_breeds, width = 8, height = 6)
```

```{r}
filtered_breeds %>%
  count(Breed)
```


```{r}
N <- 20
top_breeds_sex_production <- combined_data_without_outliers %>%
  count(Breed, sort=TRUE, Sex, Beef_or_Dairy) %>%
  top_n(N, n)
top_breeds_sex_production

# Create the bar plot
breed_by_sex <- ggplot(top_breeds_sex_production, aes(x=Breed, y=n, fill=Sex)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title="Distribution of Breeds by Sex", x="Breed", y="No Of animals") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(labels = scales::comma)
breed_by_sex
breed_by_production <- ggplot(top_breeds_sex_production, aes(x=Breed, y=n, fill=Beef_or_Dairy)) +
  geom_bar(stat="identity", position=position_dodge()) +
  labs(title="Distribution of breeds by production type", x="Breed", y="No Of animals") +
  theme(axis.text.x = element_text(color = "grey20", size = 14, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 14, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 14, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 14, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(labels = scales::comma)
breed_by_production
ggsave("./data/combined_figs/breed_by_sex.png", plot=breed_by_sex, width=8, height = 6)
ggsave("./data/combined_figs/breed_by_production.png", plot = breed_by_production, width = 8, height = 6)
```
We have 92 different breeds. 
While 20 breeds have less than 10 animals.
6 breeds have more than 100k animals this is 82% of the total animals


Abattoir_._Died_on_Farm:
31% of dairy animals died on farm and only 9% of the beef animals died on farm
```{r}
No_beef_no_outliers <-sum(combined_data_without_outliers$Beef_or_Dairy=="Beef")
No_dairy_no_outliers <-sum(combined_data_without_outliers$Beef_or_Dairy=="Dairy")
```


```{r}
place_of_death_summary <- combined_data_without_outliers %>%
  group_by(Abattoir_._Died_on_Farm) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
place_of_death_summary
```


```{r}
summary(combined_data_without_outliers %>%
  filter(Abattoir_._Died_on_Farm=="Abattoir") )
summary(combined_data_without_outliers %>%
  filter(Abattoir_._Died_on_Farm=="Died on Farm"))

```


```{r}
Where_died_freq_table <- combined_data_without_outliers %>%
  count(Abattoir_._Died_on_Farm, Beef_or_Dairy)
Where_died_freq_table
paste("Proportion of dairy animal died on farm = ", Where_died_freq_table$n[Where_died_freq_table$Abattoir_._Died_on_Farm=="Died on Farm" & Where_died_freq_table$Beef_or_Dairy=="Dairy"]/No_dairy_no_outliers *100, "%")
paste("Proportion of beef animal died on farm = ", Where_died_freq_table$n[Where_died_freq_table$Abattoir_._Died_on_Farm=="Died on Farm" & Where_died_freq_table$Beef_or_Dairy=="Beef"]/No_beef_no_outliers *100, "%")

```



```{r}
place_of_death <- ggplot(combined_data_without_outliers, aes(x=Abattoir_._Died_on_Farm, fill=Beef_or_Dairy)) +
  geom_bar(color="steelblue") + theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) +
  labs(title="Place of animal death", x="Place", y="Animals")
place_of_death
ggsave("./data/combined_figs/place_of_death.png", plot = place_of_death, width = 8, height = 6)
```


Beef_or_Dairy:

```{r}
production_summary <- combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
production_summary
```


```{r}
Beef_or_Dairy_freq_table <- combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  summarise(frequency = n(), prcnt=frequency/total_animals_no_outliers*100) %>%
  arrange(desc(frequency))
Beef_or_Dairy_freq_table
Beef_or_Dairy_freq_table[[2, 2]]
paste(round(Beef_or_Dairy_freq_table[[1, 3]], 2), "% of the total number of animals is for beef")
paste(round(Beef_or_Dairy_freq_table[[2, 3]], 2), "% of the total number of animals is for dairy")
```

```{r}
beef_or_dairy_barplot <- ggplot(combined_data_without_outliers, aes(x=Beef_or_Dairy)) +
  geom_bar(color="steelblue", fill="steelblue") +
  labs(title="Type of production animal", x="Beef or Dairy", y="Animals")+
  theme_minimal() 
beef_or_dairy_barplot
ggsave("./data/combined_figs/beef_or_dairy_barplot.png", plot=beef_or_dairy_barplot, width=8, height = 6)

```




### Numerical Variables

####Total conditions per animal
```{r}

summary(combined_data_without_outliers[, "Total_Conditions_per_Animal"])
```



how many animals per number of conditions?
```{r}

conditions_table <- table(combined_data_without_outliers$Total_Conditions_per_Animal)
conditions_table
paste("animals without conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==0)/total_animals_no_outliers*100, 2), "%")
paste("animals with 1 condition:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==1)/total_animals_no_outliers*100, 2), "%")
paste("animals with 2 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==2)/total_animals_no_outliers*100, 2), "%")
paste("animals with 3 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==3)/total_animals_no_outliers*100, 2), "%")
paste("animals with >= 3 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal>=3)/total_animals_no_outliers*100, 2), "%")


paste("animals with 4 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==4)/total_animals_no_outliers*100, 2), "%")
paste("animals with 5 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==5)/total_animals_no_outliers*100, 2), "%")
paste("animals with 6 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==6)/total_animals_no_outliers*100, 2), "%")
paste("animals with 7 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==7)/total_animals_no_outliers*100, 2), "%")
paste("animals with 8 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==8)/total_animals_no_outliers*100, 2), "%")
paste("animals with 9 conditions:", round(sum(combined_data_without_outliers$Total_Conditions_per_Animal==9)/total_animals_no_outliers*100, 2), "%")
```


```{r}
total_conditions_summary <- combined_data_without_outliers %>%
  group_by(Total_Conditions_per_Animal) %>%
  summarise(
    number_of_animals = n(),
    mean_age = mean(days_alive),
    percent_of_total_animals = number_of_animals * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    percent_dairy = mean(Beef_or_Dairy == "Dairy") * 100,
    percent_beef = mean(Beef_or_Dairy == "Beef") * 100,
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
total_conditions_summary
```




Total conditions per animal histogram
```{r}
total_conditions_hist <- ggplot(combined_data_without_outliers, aes(x=Total_Conditions_per_Animal))  + scale_y_continuous(trans='log10') +
  geom_histogram(binwidth=0.5, fill="steelblue") +
  geom_vline(aes(xintercept= mean(Total_Conditions_per_Animal), color="red")) +
  labs(title="Total conditions per animal", x="Conditions", y="Animals") +
  theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) 
total_conditions_hist
ggsave("./data/combined_figs/total_conditions_hist.png", plot=total_conditions_hist, width=8, height = 6)

```

Box plot of conditions per animal
```{r}
ggplot(combined_data_without_outliers, aes(x=Total_Conditions_per_Animal)) +
  geom_boxplot() +
  labs(title="boxplot")+
  theme_minimal()
```


```{r}
total_conditions_hist_by_production <- ggplot(combined_data_without_outliers, aes(x=Total_Conditions_per_Animal, fill=Beef_or_Dairy)) +
  geom_histogram(binwidth=1) +
  geom_vline(aes(xintercept= mean(Total_Conditions_per_Animal), color="red")) +
  labs(title="No of conditions per animal by production type", x="conditions", y="Animals") +
  theme_minimal()
total_conditions_hist_by_production
ggsave("./data/combined_figs/total_conditions_hist_by_production.png", plot=total_conditions_hist_by_production, width=8, height = 6)
```


### Temperature
```{r}

aggregate(T_2M ~ Sex + Beef_or_Dairy + Abattoir_._Died_on_Farm, combined_data_without_outliers, mean)
```

```{r}
low_temperatures <- combined_data_without_outliers %>%
  filter(T_2M < 6.05) %>%
  summarise(
    number_of_animals = n(),
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
medium_temperatures <- combined_data_without_outliers %>%
  filter(T_2M >= 6.05 & T_2M <= 12.760) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
high_temperatures <- combined_data_without_outliers %>%
  filter(T_2M > 12.760) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))

temperature_summary <- rbind(low_temperatures, medium_temperatures, high_temperatures)
temperature_summary

```
```{r}
combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(T_2M < 6.05) %>%
  summarise(animals= n(),
    mean_age = mean(days_alive))

combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(T_2M >= 6.05 & T_2M <= 12.76) %>%
  summarise(animals= n(),
            mean_age = mean(days_alive))

combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(T_2M > 12.76) %>%
  summarise(animals= n(),
    mean_age = mean(days_alive))
```


```{r}
low_rh <- combined_data_without_outliers %>%
  filter(RH2M < 86.00) %>%
  summarise(
    number_of_animals = n(),
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
medium_rh <- combined_data_without_outliers %>%
  filter(RH2M >= 86.00 & T_2M <= 92) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))
high_rh <- combined_data_without_outliers %>%
  filter(RH2M > 92) %>%
  summarise(
    mean_age = mean(days_alive),
    percent_of_total_animals = n() * 100/ total_animals_no_outliers,
    percent_male = mean(Sex == "M") * 100,
    percent_female = mean(Sex == "F") * 100,
    percent_bull = mean(Sex == "B") * 100,
    Abattoir_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Abattoir") / n(),
    Farm_deaths = 100 * sum(Abattoir_._Died_on_Farm == "Died on Farm") / n(),
    mean_total_conditions = mean(as.integer(Total_Conditions_per_Animal)),
    number_of_animals = n(),
  percent_healthy_animals = sum(Total_Conditions_per_Animal==0) / number_of_animals *100) %>%
  arrange(desc(number_of_animals))

rh_summary <- rbind(low_temperatures, medium_temperatures, high_temperatures)
rh_summary
```

```{r}
combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(RH2M < 86.00) %>%
  summarise(animals= n(),
    mean_age = mean(days_alive))

combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(RH2M >= 86.00 & T_2M <= 92.00) %>%
  summarise(animals= n(),
            mean_age = mean(days_alive))

combined_data_without_outliers %>%
  group_by(Beef_or_Dairy) %>%
  filter(RH2M > 92.00) %>%
  summarise(animals= n(),
    mean_age = mean(days_alive))
```

```{r}

summary(combined_data_without_outliers[, "T_2M"])

summary(combined_data_without_outliers[, "RH2M"])
```


```{r}
temperature_hist <- ggplot(combined_data_without_outliers, aes(x=T_2M)) +
  geom_histogram(binwidth=0.5, fill="steelblue") +
  geom_vline(aes(xintercept= mean(T_2M), color="red")) +
  labs(title="Temperature during death", x="Temperature at 2m", y="Animals") +
  theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) 
temperature_hist
ggsave("./data/combined_figs/temperature_hist.png", plot=temperature_hist, width=8, height = 6)
```


```{r}
temperature_scatter_plot <- ggplot(combined_data_without_outliers, aes(x=T_2M, y=days_alive, colour = Sex)) + geom_point()
ggsave("./data/combined_figs/temperature_scatter_plot.png", plot=temperature_scatter_plot, width=8, height = 6)
temperature_scatter_plot
```

#RH2M

```{r}
humidity_ratio_scatter_plot <- ggplot(combined_data_without_outliers, aes(x=RH2M, y=days_alive, colour = Sex)) + geom_point()
ggsave("./data/combined_figs/humidity_ratio_scatter_plot.png", plot=temperature_scatter_plot, width=8, height = 6)
humidity_ratio_scatter_plot
```


```{r}
library(e1071)
temperature_skewness_value <- skewness(combined_data_without_outliers$T_2M)
print(temperature_skewness_value)
temperature_kurtosis_value <- kurtosis(combined_data_without_outliers$T_2M)
print(temperature_kurtosis_value)
paste("with a skewness value of ", temperature_skewness_value, "our data seems to be fairly symmetrical")
paste("with a kurtosis value of ", temperature_kurtosis_value, "our data seems to have thinner tail than the normal distribution")
```


```{r}
ggplot(combined_data_without_outliers, aes(y=T_2M)) +
  geom_boxplot() +
  labs(title="boxplot of 2m temperature")+
  theme_minimal()
```



```{r}
box_plot_temperature_by_production <- ggplot(combined_data_without_outliers, aes(x = Beef_or_Dairy, y = T_2M, fill = Beef_or_Dairy)) +
  geom_boxplot() +
  labs(title = "Temperature during death by production type",
       x = "Production type",
       y = "Temperature C") + theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA))  

ggsave("./data/combined_figs/box_plot_temperature_by_production.png", plot=box_plot_temperature_by_production, width = 8, height = 6, bg = "transparent")
box_plot_temperature_by_production
```


```{r}
box_plot_temperature_by_sex <- ggplot(combined_data_without_outliers, aes(x = Sex, y = T_2M, fill = Sex)) +
  geom_boxplot() +
  labs(title = "Temperature during death by Sex",
       x = "Sex",
       y = "Temperature C") + theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA))  

ggsave("./data/combined_figs/box_plot_temperature_by_sex.png", plot=box_plot_temperature_by_sex, width = 8, height = 6, bg = "transparent")
box_plot_temperature_by_sex
```



```{r}
temperature_by_production_deaths <- ggplot(combined_data_without_outliers, aes(x=T_2M, fill=Beef_or_Dairy)) +
  geom_histogram(binwidth=1) +
  geom_vline(aes(xintercept= mean(T_2M), color="red")) +
  labs(title="Deaths by production type for each temperature", x="Temperature at 2m", y="Animals") +
  theme_minimal()
temperature_by_production_deaths
ggsave("./data/combined_figs/temperature_by_production_deaths.png", plot=temperature_by_production_deaths, width=8, height = 6)
```




### Condition columns
# keep only the unhealthy animals


```{r}
unhealthy <- combined_data_without_outliers %>%
  filter(Total_Conditions_per_Animal>0)
unhealthy
sum(unhealthy$TB)
conditions_names <- colnames(unhealthy[21:92])
conditions_names
conditions_names[colSums(unhealthy[, 21:92]) > 1000]

summary(colSums(unhealthy[, 21:92]))
print("we 18 have conditions that are extremely rare such as:")
conditions_names[colSums(unhealthy[, 21:92]) < 16 ]

print("some conditions are more often but again not so much:" )
conditions_names[colSums(unhealthy[, 21:92]) > 16 & colSums(unhealthy[, 21:92]) <= 3952]

print("some conditions are more common:" )
conditions_names[colSums(unhealthy[, 21:92]) > 3952]

```
```{r}
colSums(unhealthy[, 21:92])
```
# Create data frame for all conditions
```{r}
conditions_list <- colnames(unhealthy[21:92])
num_conditions <- length(conditions_list)


all_conditions_df <- data_frame()

for (i in 1:num_conditions) {
  condition <- conditions_list[i]
  condition_slice <- unhealthy %>%
    filter(unhealthy[condition]>0) %>%
    summarise(animals = n(),
              mean_age = mean(days_alive),
              prcnt_male = mean(Sex == "M") * 100, 
              prcnt_female = mean(Sex == "F") * 100, 
              prcnt_bull = mean(Sex == "B") * 100, 
              prcnt_beef = mean(Beef_or_Dairy == "Beef") * 100, 
              prcnt_dairy = mean(Beef_or_Dairy == "Dairy") * 100, 
              prcnt_abattoir = mean(Abattoir_._Died_on_Farm == "Abattoir") * 100, 
              prcnt_farm = mean(Abattoir_._Died_on_Farm == "Died on Farm") * 100)
  row.names(condition_slice) <- condition
  all_conditions_df <- rbind(all_conditions_df, condition_slice)
}
all_conditions_df %>%
  arrange(desc(animals))
summary(all_conditions_df$mean_age)
all_conditions_df[all_conditions_df$mean_age >2000,]
summary(unhealthy$days_alive)
```

```{r}
unhealthy %>%
  filter(Abattoir_._Died_on_Farm == "Died on Farm")
```

```{r}
unhealthy_hist <- ggplot(unhealthy, aes(x=days_alive)) +
  geom_histogram(binwidth=1, fill="steelblue") +
  geom_vline(aes(xintercept= mean(days_alive), color="red")) +
  labs(title="Age in days for unhealthy animals", x="Days", y="Animals") +
  theme(axis.text.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 16, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size = 16, angle = 0, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 16, angle = 90, hjust = .5, vjust = .5, face = "plain"),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA)) 
unhealthy_hist
ggsave("./data/combined_figs/unhealthy_hist.png", plot=unhealthy_hist, width=8, height = 6)
```


```{r}
combined_data_conditions <- combined_data_without_outliers[, 20:92] %>%
  colSums()
combined_data_conditions
conditions_df <- data.frame(conditions=c(colnames(combined_data_without_outliers[20:92])),
                            frequency=c(combined_data_conditions))
rownames(conditions_df) <- NULL
conditions_df

top_conditions <- conditions_df %>%
  subset(conditions_df$frequency > 2000)
top_conditions <- top_conditions[order(-top_conditions$frequency),]
top_conditions

ggplot(data = top_conditions, aes(x = conditions, y = frequency)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_minimal() +
  labs(title = "Frequency of Conditions",
       x = "Condition",
       y = "Frequency") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r}
top_conditions_without_no <- top_conditions[-1, ]
ggplot(top_conditions_without_no, aes(x = conditions, y = frequency)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_minimal() +
  labs(title = "Frequency of Conditions",
       x = "Condition",
       y = "Frequency") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# TO DO: check for correlations Between mean age and all other variables
```{r}
ggplot(filtered_breeds, mapping = aes(days_alive, Breed)) +
  geom_point()
```

```{r}
ggqqplot(combined_data_without_outliers, x = "days_alive",
   color = "Beef_or_Dairy", 
   palette = c("#0073C2FF", "#FC4E07"),
   ggtheme = theme_pubclean())
```

```{r}
ggqqplot(combined_data_without_outliers, x = "days_alive",
   color = "Sex", 
   ggtheme = theme_pubclean())
```
```


