---
title: "prepare_data_for_modelling"
author: "Marietta_Dalamanga"
date: "2024-07-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(dplyr)
library(tidyr)
library(caret)
library(ggplot2)
library(scales)
```

```{r}
memory.limit(size=70000)
```

```{r}
survival_data_without_outliers <- read.csv("./data/new_combined_data_without_outliers.csv")
```

I will drop the rows with na for now until Emily tells me what to do with this values
```{r}
survival_data_without_outliers <-drop_na(survival_data_without_outliers)
```


# keep only conditions with more than 1000 animals
We will keep only the animals with common condition


```{r}
colnames(survival_data_without_outliers)
conditions_columns <- colnames(survival_data_without_outliers[22:93])
conditions_columns
conditions_sums <- colSums(survival_data_without_outliers[, conditions_columns])
conditions_sums
rare_conditions_columns <- c(conditions_columns[conditions_sums < 2000])
rare_conditions_columns

```
keep only those columns

```{r}
filtered_rare_conditions <- survival_data_without_outliers
filtered_rare_conditions[rare_conditions_columns] <- list(NULL)
filtered_rare_conditions
```

Delete those rows where the animal has only rare conditions
```{r}
rare_conditions_data <- filtered_rare_conditions %>%
  filter(Total_Conditions_per_Animal > 0 & rowSums(filtered_rare_conditions[22:45]) == 0) 

common_conditions_data <- filtered_rare_conditions %>%
  filter(Total_Conditions_per_Animal== 0 | rowSums(filtered_rare_conditions[22:45]) >0 ) 
  
```
I will delete 2693 entries where the animals don't have any of the common conditions ### this was on the data before the herd size and the deletion of missing values
Now it is 2690 entries

```{r}
common_conditions_data
```

# Now we will delete those rows that the animals belong to a rare breed 

```{r}
N <- 8
top_breeds <- common_conditions_data %>%
  dplyr::count(Breed, sort=TRUE) %>%
  top_n(N, n) %>%
  pull(Breed)

top_breeds
common_conditions_breed_data <- common_conditions_data %>%
  filter(Breed %in% top_breeds)

nrow(common_conditions_breed_data)/nrow(common_conditions_data)* 100
```
Old dataset Top 8 breeds account for the 91.50% of the animals
We will keep only those
171019 rows were removed this is the 8.5% of our common_conditions_data

In the new dataset 170094 rows were removed the proportion of total animals is the same 
8.44% is on the survival data before removing the missing values
```{r}
(nrow(common_conditions_data)-nrow(common_conditions_breed_data)) / total_animals_no_outliers *100
```

```{r}
common_conditions_breed_data
```

save dataset in a csv_file to use it for parametric distributions
```{r}
write.csv(common_conditions_breed_data, "./data/common_conditions_breed_data.csv", row.names = FALSE)
```

