---
title: "Cox_models_all_variables"
author: "Marietta_Dalamanga"
date: "2024-07-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(survival)
library(survminer)
library(pec)
```

load dairy datasets
```{r}
train_data <- read_csv("./data/dairy_training_data.csv", show_col_types = FALSE)
validation_data <- read_csv("./data/dairy_validation_data.csv", show_col_types = FALSE)
```



```{r}
variables <- variable.names(train_data)
variables <- variables[-c(2, 3)]
variables 
```



smaller data set to see if it works for all variables
```{r}
# train_data1 <- train_data[1:10, ]
```

create Survival objects for each variable
```{r}
survival_object <- sapply(variables, function(x) as.formula(paste("Surv(months_alive, status) ~ ", x)))
```


Create cox model for each variable
```{r}

cox_model <- lapply(survival_object, function(x){coxph(x, data=train_data)})
cox_model[41]
```

Create a dataframe with the results of Cox model
```{r}
get_results <- lapply(cox_model, function(x){
  overview <- summary(x)
  log_death_hazard <- coef(overview)[1]
  p_value <- signif(overview$wald["pvalue"], digits=2)
  likelihood_test <- signif(overview$sctest["test"], digits=2)
  beta <- signif(overview$coef[1], digits=2)
  hazard_ratio <- signif(overview$coef[2], digits=2)
  hr_conf_lower <- signif(overview$conf.int[3], 2)
  hr_conf_upper <- signif(overview$conf.int[4], 2)
  hazard_ratio <- paste0(hazard_ratio, " (", 
                         hr_conf_lower, "-", hr_conf_upper, ")")
  results <- c(beta, hazard_ratio, likelihood_test, p_value)
  names(results) <- c("beta", "change in hazard (95% CI for hazard ratio)", "likelihood_test", "p_value")
  return(results)
  })
```



```{r}
results_for_all <- t(as.data.frame(get_results, check.names = FALSE))
results_for_all <- as.data.frame(results_for_all)
results_for_all
```



```{r}
variables <- variables[-c(55, 59, 60, 62, 63, 64, 65)]
variables 
```

```{r}
colSums(train_data)
```


```{r}
cox_multi <- coxph(Surv(months_alive, status) ~ Omagh + ab_ba747dbffafe62fb8bea541fd72df6d8c7afcb2f, data = train_data)
cox_multi
```

Modelling attempt with all variables
```{r}
cox_multi <- coxph(Surv(months_alive, status) ~  Total_Conditions_per_Animal + T_2M + RH2M + No + TB + FACTORY.DAMAGE +
                                  FASCIOLIASIS + PLEURISY + NAD + NEPHRITIS + SCAR.TISSUE + INJECTION.SITES + ABSCESS.PYAEMIA +
                                  CONTAMINATION + ACTINO + BRUISING + HYDRONEPHROSIS + TELANGECTASIS + PETECHAE.HAEMORRHAGES +
                                   PERICARDITIS + FEVERED + PLEUR.PNEUMONIA.GENERAL + PERITONITIS + PLEUR.PNEUMONIA.LOCAL + 
                                   RESIDUES + HAEMATOMA + ARTHRITIS + TB.GENERALISED + OEDEMA + EMACIATION + Armagh + 
                                  Ballymena + Coleraine + Dungannon + Enniskillen + LondonDerry + Mallusk + Newry + NtArds + 
                                  Omagh + ab_4f71277e271f09349a4d6d5f6c05acf635652015 + ab_6f7d51dd8564e05e279faa791f97894ef141a4db +
                                  ab_32d8a591f643abd1ff6a998b128403c8962a55d8 + ab_f833f5d69610136a115182502764c803be97ee16 + 
                                  ab_94003c4910d6c601a698a3258918fc822b88dd0d + ab_332a6a1d2843f367c160a1c7c3fb2a28f0f8909e + 
                                  ab_568a97a7e2a6685902dd553c276b1837e0ebf06b + ab_ae2f3299f13dc08c27a4bd4586901243017aa1c0 + 
                                  ab_9032d4760ad9a99eb868b5d854cbae1492401dda + ab_8a60fb1b9b40ed0fdc5d3c061e9388972f3bdce4 + 
                                  ab_87fc1df58026b8a228f9c4afa002b2b7722a8f09 + ab_cdf0a11f70869c640bfe6c23935ff3da4acfb7b0 + 
                                  ab_ba747dbffafe62fb8bea541fd72df6d8c7afcb2f + FR + HOL + F + B + M + died_on_abattoir + died_on_farm, 
                   data = train_data)
summary(cox_multi)
```


Now we get rid of problematic variables
```{r}
cox_multi_limited <- coxph(Surv(months_alive, status) ~  Total_Conditions_per_Animal + T_2M + RH2M + No + TB + FACTORY.DAMAGE +
                                  FASCIOLIASIS + PLEURISY + NAD + NEPHRITIS + SCAR.TISSUE + INJECTION.SITES + ABSCESS.PYAEMIA +
                                  CONTAMINATION + ACTINO + BRUISING + HYDRONEPHROSIS + TELANGECTASIS + PETECHAE.HAEMORRHAGES +
                                   PERICARDITIS + FEVERED + PLEUR.PNEUMONIA.GENERAL + PERITONITIS + PLEUR.PNEUMONIA.LOCAL + 
                                   RESIDUES + HAEMATOMA + ARTHRITIS + TB.GENERALISED + OEDEMA + EMACIATION + Armagh + 
                                  Ballymena + Coleraine + Dungannon + Enniskillen + LondonDerry + Mallusk + Newry + NtArds + 
                                  ab_4f71277e271f09349a4d6d5f6c05acf635652015 + ab_6f7d51dd8564e05e279faa791f97894ef141a4db +
                                  ab_32d8a591f643abd1ff6a998b128403c8962a55d8 + ab_f833f5d69610136a115182502764c803be97ee16 + 
                                  ab_94003c4910d6c601a698a3258918fc822b88dd0d + ab_332a6a1d2843f367c160a1c7c3fb2a28f0f8909e + 
                                  ab_568a97a7e2a6685902dd553c276b1837e0ebf06b + ab_ae2f3299f13dc08c27a4bd4586901243017aa1c0 + 
                                  ab_9032d4760ad9a99eb868b5d854cbae1492401dda + ab_8a60fb1b9b40ed0fdc5d3c061e9388972f3bdce4 + 
                                  ab_87fc1df58026b8a228f9c4afa002b2b7722a8f09 + ab_cdf0a11f70869c640bfe6c23935ff3da4acfb7b0 + 
                                  ab_ba747dbffafe62fb8bea541fd72df6d8c7afcb2f + FR  + F + B + died_on_abattoir, 
                   data = train_data)
summary(cox_multi_limited)
```





```{r}
selectedSupermodel <- selectCox(Surv(train_data$months_alive, train_data$status) ~ 
                                  Total_Conditions_per_Animal + T_2M + RH2M + No + TB + FACTORY.DAMAGE +
                                  FASCIOLIASIS + PLEURISY + NAD + NEPHRITIS + SCAR.TISSUE + INJECTION.SITES + ABSCESS.PYAEMIA +
                                  CONTAMINATION + ACTINO + BRUISING + HYDRONEPHROSIS + TELANGECTASIS + PETECHAE.HAEMORRHAGES +
                                   PERICARDITIS + FEVERED + PLEUR.PNEUMONIA.GENERAL + PERITONITIS + PLEUR.PNEUMONIA.LOCAL + 
                                   RESIDUES + HAEMATOMA + ARTHRITIS + TB.GENERALISED + OEDEMA + EMACIATION + Armagh + 
                                  Ballymena + Coleraine + Dungannon + Enniskillen + LondonDerry + Mallusk + Newry + NtArds + 
                                  ab_4f71277e271f09349a4d6d5f6c05acf635652015 + ab_6f7d51dd8564e05e279faa791f97894ef141a4db +
                                  ab_32d8a591f643abd1ff6a998b128403c8962a55d8 + ab_f833f5d69610136a115182502764c803be97ee16 + 
                                  ab_94003c4910d6c601a698a3258918fc822b88dd0d + ab_332a6a1d2843f367c160a1c7c3fb2a28f0f8909e + 
                                  ab_568a97a7e2a6685902dd553c276b1837e0ebf06b + ab_ae2f3299f13dc08c27a4bd4586901243017aa1c0 + 
                                  ab_9032d4760ad9a99eb868b5d854cbae1492401dda + ab_8a60fb1b9b40ed0fdc5d3c061e9388972f3bdce4 + 
                                  ab_87fc1df58026b8a228f9c4afa002b2b7722a8f09 + ab_cdf0a11f70869c640bfe6c23935ff3da4acfb7b0 + 
                                  ab_ba747dbffafe62fb8bea541fd72df6d8c7afcb2f + FR + F + B + died_on_abattoir 
                                , data=train_data)

selectedSupermodel
```




```{r}
fit <- selectCox(Surv(train_data$months_alive, train_data$status) ~ 
                                  Total_Conditions_per_Animal + T_2M + RH2M + No + TB + FACTORY.DAMAGE +
                                  FASCIOLIASIS + PLEURISY + NAD + NEPHRITIS + SCAR.TISSUE + INJECTION.SITES + ABSCESS.PYAEMIA +
                                  CONTAMINATION + ACTINO + BRUISING + HYDRONEPHROSIS + TELANGECTASIS + PETECHAE.HAEMORRHAGES +
                                   PERICARDITIS + FEVERED + PLEUR.PNEUMONIA.GENERAL + PERITONITIS + PLEUR.PNEUMONIA.LOCAL + 
                                   RESIDUES + HAEMATOMA + ARTHRITIS + TB.GENERALISED + OEDEMA + EMACIATION + Armagh + 
                                  Ballymena + Coleraine + Dungannon + Enniskillen + LondonDerry + Mallusk + Newry + NtArds + 
                                  ab_4f71277e271f09349a4d6d5f6c05acf635652015 + ab_6f7d51dd8564e05e279faa791f97894ef141a4db +
                                  ab_32d8a591f643abd1ff6a998b128403c8962a55d8 + ab_f833f5d69610136a115182502764c803be97ee16 + 
                                  ab_94003c4910d6c601a698a3258918fc822b88dd0d + ab_332a6a1d2843f367c160a1c7c3fb2a28f0f8909e + 
                                  ab_568a97a7e2a6685902dd553c276b1837e0ebf06b + ab_ae2f3299f13dc08c27a4bd4586901243017aa1c0 + 
                                  ab_9032d4760ad9a99eb868b5d854cbae1492401dda + ab_8a60fb1b9b40ed0fdc5d3c061e9388972f3bdce4 + 
                                  ab_87fc1df58026b8a228f9c4afa002b2b7722a8f09 + ab_cdf0a11f70869c640bfe6c23935ff3da4acfb7b0 + 
                                  ab_ba747dbffafe62fb8bea541fd72df6d8c7afcb2f + FR + F + B + died_on_abattoir 
                                , data=train_data)

selectedSupermodel

```

visualise the selectedsupermodel
```{r}
ggsurvplot(survfit(selectedSupermodel), ggtheme = theme_minimal())
```

