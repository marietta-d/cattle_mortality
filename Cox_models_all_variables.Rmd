---
title: "Cox_models_all_variables"
author: "Marietta_Dalamanga"
date: "2024-07-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(survival)
library(survminer)
```

load dairy datasets
```{r}
train_data <- read_csv("./data/dairy_training_data.csv", show_col_types = FALSE)
validation_data <- read_csv("./data/dairyf_validation_data.csv", show_col_types = FALSE)
```


```{r}
variables <- variable.names(train_data)
variables
#variables[-c(11, 12)]
```

Change type of data factor
```{r}
train_data[,c("Dvo_Code", "Year", "Month",  "Herd_Id", "Abbatoir", "Breed", "Sex", "Abattoir_._Died_on_Farm")] =
  lapply(train_data[,c("Dvo_Code", "Year", "Month",  "Herd_Id", "Abbatoir", "Breed", "Sex", "Abattoir_._Died_on_Farm")], function(x) as.factor(x))
```


smaller data set to see if it works for all variables
```{r}
train_data1 <- train_data[1:10, ]
```

create Survival objects for each variable
```{r}
survival_object <- sapply(variables, function(x) as.formula(paste("Surv(months_alive, status) ~ ", x)))
survival_object
```

```{r}
cox_model <- coxph(Surv(months_alive, status) ~ FASCIOLIASIS + FLUKE.DAMAGE + TB + FACTORY.DAMAGE + No + EMACIATION + TB.GENERALISED, data = train_data )
summary(cox_model)
```
Create cox model for each variable
```{r}
cox_model <- lapply(survival_object, function(x){coxph(x, data=train_data1)})
```

Create a dataframe with the results of Cox model
```{r}
get_results <- lapply(cox_model, function(x){
  overview <- summary(x)
  log_death_hazard <- coef(overview)[1]
  p_value <- signif(overview$wald["pvalue"], digits=2)
  likelihood_test <- signif(overview$sctest["test"], digits=2)
  beta <- signif(overview$coef[1], digits=2)
  hazard_ratio <- signif(overview$coef[2], digits=2)
  hr_conf_lower <- signif(overview$conf.int[3], 2)
  hr_conf_upper <- signif(overview$conf.int[4], 2)
  hazard_ratio <- paste0(hazard_ratio, " (", 
                         hr_conf_lower, "-", hr_conf_upper, ")")
  results <- c(beta, hazard_ratio, likelihood_test, p_value)
  names(results) <- c("beta", "change in hazard (95% CI for hazard ratio)", "likelihood_test", "p_value")
  return(results)
  })
```



```{r}
results_for_all <- t(as.data.frame(get_results, check.names = FALSE))
results_for_all <- as.data.frame(results_for_all)
results_for_all

```


